name: Create 7z

on:
#  schedule:
#    - cron: '40 3 * * *'
  push:
    branches: [ ReleaseFileAction ]

jobs:
  create-7z:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: Development

      - name: Install 7zip
        run: |
          sudo apt-get update
          sudo apt-get install -y p7zip-full

      - name: Get version
        id: get_version
        run: |
          if [ ! -f "spruce/spruce" ]; then
            echo "Error: spruce/spruce file not found"
            exit 1
          fi
          echo "version=$(cat spruce/spruce)" >> "$GITHUB_OUTPUT"

      - name: Create 7z archive
        run: |
          7z a -t7z -mx=9 "spruceV${{ steps.get_version.outputs.version }}.7z" * \
            -xr!.git* \
            -x!.gitignore \
            -x!.gitattributes \
            -x!create_spruce_release.bat \
            -x!create_spruce_release.sh

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: spruceV${{ steps.get_version.outputs.version }}.7z
          tag_name: v${{ steps.get_version.outputs.version }}
          repository: spruceUI/spruceOSNightlies
          draft: false
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}