name: Create Nightly

on:
  workflow_dispatch:

jobs:
  create-7z:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          ref: Development
          fetch-depth: 0

      - name: Install 7zip and zip
        run: |
          sudo apt-get update
          sudo apt-get install -y p7zip-full zip jq

      - name: Get version and date
        id: get_version
        run: |
          if [ ! -f "spruce/spruce" ]; then
            echo "Error: spruce/spruce file not found"
            exit 1
          fi

          VERSION="$(< spruce/spruce)"
          echo "version=${VERSION}-$(date '+%Y%m%d')" >> "$GITHUB_OUTPUT"

          {
            echo "Last commit: $(git rev-parse HEAD)"
            echo ""
            echo "Changes in last 24 hours:"
            git log --since="24 hours ago" --pretty=format:'- %s (%an)'
          } > commits_nightly.txt

      - name: Check for commits
        id: check_commits
        run: |
          COMMITS=$(git log --since="24 hours ago" --pretty=format:'- %s (%an)%n')
          if [ -z "$COMMITS" ]; then
            echo "No commits in the last 24 hours"
            exit 1
          fi
          {
            echo "commits<<EOF"
            echo "$COMMITS"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Recombine large files
        run: |
          if ls spruce/flip/miyoo355_rootfs_32.img_part* 1>/dev/null 2>&1; then
            cat spruce/flip/miyoo355_rootfs_32.img_part* > spruce/flip/miyoo355_rootfs_32.img
            rm -f spruce/flip/miyoo355_rootfs_32.img_part*
          fi

          if ls spruce/flip/muOS-pixie-reduced.sqsh-part* 1>/dev/null 2>&1; then
            cat spruce/flip/muOS-pixie-reduced.sqsh-part* > spruce/flip/muOS-pixie-reduced.sqsh
            rm -f spruce/flip/muOS-pixie-reduced.sqsh-part*
          fi

          if ls RetroArch/.retroarch/cores64/scummvm_libretro.so.part* 1>/dev/null 2>&1; then
            cat RetroArch/.retroarch/cores64/scummvm_libretro.so.part* > RetroArch/.retroarch/cores64/scummvm_libretro.so
            rm -f RetroArch/.retroarch/cores64/scummvm_libretro.so.part*
          fi

      - name: Pull selected PyUI Themes
        run: |
          git clone --depth=1 https://github.com/spruceUI/PyUI-Themes.git pyui_themes
          mkdir -p Themes
          cp pyui_themes/PackedThemes/*.7z Themes/ || true
          rm -rf pyui_themes

      - name: Create 7z archive
        run: |
          7z a -t7z -mx=9 -mf=off "spruceV${{ steps.get_version.outputs.version }}.7z" * .tmp_update \
            -xr!.git -xr!.github -x!.gitignore -x!.gitattributes \
            -x!create_spruce_release.bat -x!create_spruce_release.sh \
            -x!commits_nightly.txt

          7z u "spruceV${{ steps.get_version.outputs.version }}.7z" commits_nightly.txt

      - name: Create and split ZIP archive
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          ZIP_FILE="spruceV${VERSION}.zip"

          echo "Creating full ZIP..."
          zip -r -9 "$ZIP_FILE" * .tmp_update commits_nightly.txt \
            -x '*.git/*' -x '.github/*' \
            -x 'create_spruce_release.bat' -x 'create_spruce_release.sh' \
            -x "spruceV${VERSION}.7z"

          echo "Splitting ZIP into 1.5GB parts..."
          zipsplit -n 1610612736 "$ZIP_FILE"

          echo "Renaming split parts..."
          COUNT=1
          for PART in "${ZIP_FILE}".z*; do
            NEW_PART="spruceV${VERSION}.z$(printf "%02d" $COUNT)"
            mv "$PART" "$NEW_PART"
            COUNT=$((COUNT+1))
          done

          # Delete original zip
          rm "$ZIP_FILE"

          echo "ZIP split parts ready:"
          ls -lh spruceV${VERSION}.z*

      - name: Prepare release files list
        id: zip_files
        run: |
          {
            echo "files<<EOF"
            echo "spruceV${{ steps.get_version.outputs.version }}.7z"
            for file in spruceV${{ steps.get_version.outputs.version }}.z*; do
              [ -f "$file" ] && echo "$file"
            done
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: success() && steps.check_commits.outcome == 'success'
        with:
          tag_name: v${{ steps.get_version.outputs.version }}
          body: ${{ steps.check_commits.outputs.commits }}
          files: ${{ steps.zip_files.outputs.files }}
          repository: spruceUI/spruceOSNightlies
          token: ${{ secrets.PAT_TOKEN }}
          draft: false
          prerelease: false
          fail_on_unmatched_files: true

      - name: Delete old releases
        if: success() && steps.check_commits.outcome == 'success'
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          RELEASES=$(gh api repos/spruceUI/spruceOSNightlies/releases --paginate |
            jq -r '.[] | select(.tag_name | contains("-Beta") | not) | .id')

          COUNT=0
          for RELEASE_ID in $RELEASES; do
            COUNT=$((COUNT + 1))
            if [ $COUNT -gt 3 ]; then
              gh api repos/spruceUI/spruceOSNightlies/releases/$RELEASE_ID -X DELETE
            fi
          done
